import streamlit as st
import torch
from PIL import Image

# --- 1. è¨­å®šã¨æº–å‚™ ---
st.set_page_config(page_title="æ˜­å’Œãƒ¬ãƒˆãƒ­ã‚«ãƒ¡ãƒ©", layout="centered")

# ã‚·ãƒ‹ã‚¢å‘ã‘æ¥µå¤ªCSSãƒãƒƒã‚¯
st.markdown("""
<style>
div.stButton > button:first-child {
    width: 100%; height: 80px; font-size: 24px; font-weight: bold;
    border-radius: 12px; background-color: #d64040; color: white; margin-bottom: 10px;
    border: 2px solid #a83232; box-shadow: 0px 4px 0px #a83232; /* ç«‹ä½“çš„ã« */
}
div.stButton > button:active {
    box-shadow: 0px 0px 0px #a83232; transform: translateY(4px); /* æŠ¼ã—ãŸæ„Ÿ */
}
</style>
""", unsafe_allow_html=True)

# YOLOv5ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ï¼ˆåˆå›ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒèµ°ã‚Šã¾ã™ï¼‰
@st.cache_resource
def load_model():
    # ultralyticsã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰è»½é‡ãƒ¢ãƒ‡ãƒ«(yolov5s)ã‚’ãƒ­ãƒ¼ãƒ‰
    model = torch.hub.load('ultralytics/yolov5', 'yolov5s', pretrained=True)
    return model

# ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­ã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
with st.spinner('AIã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™...ï¼ˆåˆå›ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰'):
    model = load_model()

# --- 2. æ˜­å’Œã®æ€ã„å‡ºãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæ‹¡å¼µç‰ˆï¼‰ ---
# YOLOã®ã‚¯ãƒ©ã‚¹ID/åå‰ã«å¯¾å¿œã™ã‚‹æ˜­å’Œãƒã‚¿
showa_db = {
    'tv': {
        'ja': 'ğŸ“º ãƒ†ãƒ¬ãƒ“',
        'story': 'ãƒãƒ£ãƒ³ãƒãƒ«äº‰ã„ã¯ã€Œå›ã™ã€ãƒ€ã‚¤ãƒ¤ãƒ«ã®å¥ªã„åˆã„ã§ã—ãŸã­ã€‚åŠ›é“å±±ã®ç©ºæ‰‹ãƒãƒ§ãƒƒãƒ—ã€è¡—é ­ãƒ†ãƒ¬ãƒ“ã€ãã—ã¦ã€Œ8æ™‚ã ãƒ§!å…¨å“¡é›†åˆã€ã€‚å©ã‘ã°ç›´ã‚‹ã¨ä¿¡ã˜ã¦ã„ãŸã‚ã®é ƒãŒæ‡ã‹ã—ã„ã§ã™ã€‚'
    },
    'remote': {
        'ja': 'ğŸ“± ãƒªãƒ¢ã‚³ãƒ³',
        'story': 'æ˜”ã¯ãƒ†ãƒ¬ãƒ“ã‚’å¤‰ãˆã‚‹ä¿‚ã¨ã„ãˆã°å­ä¾›ã®ä»•äº‹ã§ã—ãŸã€‚åˆã‚ã¦ãƒªãƒ¢ã‚³ãƒ³ãŒå®¶ã«æ¥ãŸæ™‚ã€ã€Œé­”æ³•ã ï¼ã€ã¨æ€ã„ã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿæœ€åˆã¯ã‚³ãƒ¼ãƒ‰ä»˜ãã®æœ‰ç·šãƒªãƒ¢ã‚³ãƒ³ãªã‚“ã¦ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚'
    },
    'cup': {
        'ja': 'ğŸµ æ¹¯å‘‘ã¿ãƒ»ã‚³ãƒƒãƒ—',
        'story': 'ã¡ã‚ƒã¶å°ã‚’å›²ã‚“ã§ã€æ€¥é ˆã§æ·¹ã‚ŒãŸãŠèŒ¶ã‚’ã™ã™ã‚‹ã€‚ç¸å´ã§ã®æ—¥å‘ã¼ã£ã“ã€‚é­”æ³•ç“¶ã®ãƒãƒƒãƒˆã¯èŠ±æŸ„æ¨¡æ§˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ'
    },
    'bottle': {
        'ja': 'ğŸ¾ ç“¶ï¼ˆãƒœãƒˆãƒ«ï¼‰',
        'story': 'é…’å±‹ã•ã‚“å¾¡ç”¨èããŒæ¥ã¦ã€ãƒ“ãƒ¼ãƒ«ç“¶ã‚„é†¤æ²¹ç“¶ã‚’ã‚±ãƒ¼ã‚¹ã§é‹ã‚“ã§ãã‚Œã¾ã—ãŸã€‚ç©ºãç“¶ã‚’ãŠåº—ã«æŒã£ã¦ã„ãã¨æ•°åå††ã‚‚ã‚‰ãˆãŸã€ã‚ã®ãŠå°é£ã„ç¨¼ãã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿ'
    },
    'orange': {
        'ja': 'ğŸŠ ã¿ã‹ã‚“',
        'story': 'å†¬ã®ã“ãŸã¤ã«ã¯ã€ç®±è²·ã„ã—ãŸã¿ã‹ã‚“ãŒæ¬ ã‹ã›ã¾ã›ã‚“ã€‚æŒ‡ãŒé»„è‰²ããªã‚‹ã¾ã§é£Ÿã¹ãŸã‚Šã€çš®ã§ã‚¿ã‚³ã®ã‚ˆã†ãªå½¢ã‚’ä½œã£ãŸã‚Šã€‚å†·å‡ã¿ã‹ã‚“ã¯çµ¦é£Ÿã®æ¥½ã—ã¿ã§ã—ãŸã­ã€‚'
    },
    'person': {
        'ja': 'ğŸ‘¤ äººï¼ˆã‚ãªãŸãƒ»å®¶æ—ï¼‰',
        'story': 'é›†åˆå†™çœŸã¯ã€Œãƒã‚¤ã€ãƒãƒ¼ã‚ºã€ã€‚ç¾åƒã™ã‚‹ã¾ã§ã©ã†æ’®ã‚Œã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ãƒ¯ã‚¯ãƒ¯ã‚¯æ„ŸãŒã‚ã‚Šã¾ã—ãŸã€‚ãŠçˆ¶ã•ã‚“ã®ã‚«ãƒ¡ãƒ©ã¯å®ç‰©ã§ã€è§¦ã‚‰ã›ã¦ã‚‚ã‚‰ãˆãªã‹ã£ãŸè¨˜æ†¶ãŒã‚ã‚Šã¾ã™ã€‚'
    },
    'cat': {
        'ja': 'ğŸ± çŒ«',
        'story': 'ç¸å´ã§ä¸¸ããªã‚‹çŒ«ã€‚æ˜”ã¯ã€Œã­ã“ã¾ã‚“ã¾ã€ã‚’ã‚ã’ã¦ã„ã¾ã—ãŸã­ã€‚ã‚¿ãƒã¨ã„ã†åå‰ãŒä¸€ç•ªå¤šã‹ã£ãŸæ™‚ä»£ã€é‡è‰¯çŒ«ã‚‚åœ°åŸŸã®ã¿ã‚“ãªã§å¯æ„›ãŒã£ã¦ã„ã¾ã—ãŸã€‚'
    },
    'dog': {
        'ja': 'ğŸ¶ çŠ¬',
        'story': 'å¤–é£¼ã„ã®ã‚¹ãƒ”ãƒƒãƒ„ã‚„æŸ´çŠ¬ãŒå¤šã‹ã£ãŸã§ã™ã­ã€‚æœ¨è£½ã®çŠ¬å°å±‹ãŒã‚ã£ã¦ã€ã”é£¯ã®æ®‹ã‚Šã‚’ã‚ã’ã‚‹ã®ã‚‚å½“ãŸã‚Šå‰ã§ã—ãŸã€‚æ•£æ­©ä¸­ã«è¿‘æ‰€ã®äººã¨ç«‹ã¡è©±ã‚’ã™ã‚‹ã€ã®ã©ã‹ãªæ™‚ä»£ã§ã—ãŸã€‚'
    },
    'potted plant':{
        'ja': 'ğŸŒ¿ æ¤æœ¨ãƒ»ç›†æ ½',
        'story': 'ãŠã˜ã„ã¡ã‚ƒã‚“ãŒå¤§åˆ‡ã«ã—ã¦ã„ãŸç›†æ ½ã‚„ã€åº­ã®æ¾ã®æœ¨ã€‚æ¯æœã®æ°´ã‚„ã‚ŠãŒæ—¥èª²ã§ã—ãŸã€‚è·¯åœ°è£ã«ã¯ã‚¢ã‚µã‚¬ã‚ªã‚„ãƒ˜ãƒãƒã®é‰¢æ¤ãˆãŒä¸¦ã‚“ã§ã„ã¾ã—ãŸã­ã€‚'
    },
    'chair': {
        'ja': 'ğŸª‘ æ¤…å­ãƒ»ã‚½ãƒ•ã‚¡',
        'story': 'å¿œæ¥é–“ã®ãµã‹ãµã‹ã—ãŸã‚½ãƒ•ã‚¡ã€‚èƒŒã‚‚ãŸã‚Œã«ã¯ç™½ã„ãƒ¬ãƒ¼ã‚¹ã®ã‚«ãƒãƒ¼ãŒã‹ã‹ã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã‹ï¼ŸãŠå®¢æ§˜ãŒæ¥ãŸæ™‚ã ã‘åº§ã‚Œã‚‹ã€å°‘ã—èƒŒç­‹ãŒä¼¸ã³ã‚‹å ´æ‰€ã§ã—ãŸã€‚'
    },
    'bicycle': {
        'ja': 'ğŸš² è‡ªè»¢è»Š',
        'story': 'å¤§ããªè·å°ãŒã¤ã„ãŸå®Ÿç”¨è»Šã€‚å­ä¾›ã®é ƒã€ã‚µãƒ‰ãƒ«ã®ä¸‹ã«è¶³ã‚’é€šã™ã€Œä¸‰è§’ä¹—ã‚Šã€ã§ç·´ç¿’ã—ã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿç´™èŠå±…å±‹ã•ã‚“ãŒè‡ªè»¢è»Šã®å¾Œã‚ã«å¤ªé¼“ã‚’ç©ã‚“ã§ã‚„ã£ã¦ããŸã‚‚ã®ã§ã™ã€‚'
    },
    'clock': {
        'ja': 'â° æ™‚è¨ˆ',
        'story': 'ãƒœãƒ¼ãƒ³ã€ãƒœãƒ¼ãƒ³ã¨é³´ã‚‹æŸ±æ™‚è¨ˆã€‚æ—¥æ›œæ—¥ã«æ¤…å­ã«ä¹—ã£ã¦ã€éµç©´ã«ãƒã‚¸ã‚’å·®ã—è¾¼ã‚“ã§å·»ãã®ãŒç¿’æ…£ã§ã—ãŸã€‚æŒ¯ã‚Šå­ã®éŸ³ã‚’èããªãŒã‚‰ãŠæ˜¼å¯ã—ãŸè¨˜æ†¶ãŒè˜‡ã‚Šã¾ã™ã€‚'
    },
    'cake': {
        'ja': 'ğŸ° ã‚±ãƒ¼ã‚­',
        'story': 'ã‚¯ãƒªã‚¹ãƒã‚¹ã«é£Ÿã¹ãŸãƒã‚¿ãƒ¼ã‚¯ãƒªãƒ¼ãƒ ã®ã‚±ãƒ¼ã‚­ã€‚ä¸Šã«ä¹—ã£ã¦ã„ã‚‹èµ¤ã„ãƒ‰ãƒ¬ãƒ³ãƒã‚§ãƒªãƒ¼ã‚„ã€ãƒ”ãƒ³ã‚¯ã®ãƒãƒ©ã®èŠ±ãŒä½•ã‚ˆã‚Šã®è´…æ²¢ã§ã—ãŸã€‚ç®±ã‚’é–‹ã‘ã‚‹æ™‚ã®ç”˜ã„é¦™ã‚Šã¯ä¸€ç”Ÿã®æ€ã„å‡ºã§ã™ã€‚'
    },
    'cell phone':{
        'ja': 'ğŸ“± ã‚¹ãƒãƒ›ï¼ˆæœªæ¥ã®é›»è©±æ©Ÿï¼‰',
        'story': 'é»’é›»è©±ã®ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’ã‚¸ãƒ¼ã‚³ãƒ­ã¨å›ã—ã¦ã„ãŸæ™‚ä»£ã€èª°ãŒæƒ³åƒã—ãŸã§ã—ã‚‡ã†ã‹ã€‚ã‚¬ãƒ©ã‚¹ã®æ¿ã‚’æŒ‡ã§ãªãã‚‹ã ã‘ã§ã€ä¸–ç•Œä¸­ã¨ç¹‹ãŒã‚‹ãªã‚“ã¦ï¼ã¾ã‚‹ã§SFæ˜ ç”»ã«å‡ºã¦ãã‚‹ã€Œæœªæ¥ã®é€šä¿¡æ©Ÿã€ãã®ã‚‚ã®ã§ã™ã€‚'
    }
}

# --- 3. ã‚¢ãƒ—ãƒªç”»é¢æ§‹ç¯‰ ---
st.title("ğŸ“¸ æ˜­å’Œãƒ¬ãƒˆãƒ­ã‚«ãƒ¡ãƒ©")
st.write("å®¶ã‚„å¤–ã«ã‚ã‚‹ã‚‚ã®ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚æ‡ã‹ã—ã„ãŠè©±ãŒå‡ºã¦ãã¾ã™ã€‚")

# ã‚«ãƒ¡ãƒ©å…¥åŠ›
img_file = st.camera_input("ã“ã“ã‚’æŠ¼ã—ã¦æ’®å½±ï¼")

if img_file is not None:
    # ç”»åƒã‚’é–‹ã
    img = Image.open(img_file)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è§£æä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
    with st.spinner('æ˜­å’Œã®è¨˜æ†¶ã‚’æ¢ã—ã¦ã„ã¾ã™...'):
        # æ¨è«–å®Ÿè¡Œ
        results = model(img)
        # pandaså½¢å¼ã§çµæœã‚’å–å¾—
        df = results.pandas().xyxy[0]
        # æ¤œå‡ºã•ã‚ŒãŸåå‰ã®ãƒªã‚¹ãƒˆï¼ˆé‡è¤‡æ’é™¤ï¼‰
        detected_labels = set(df['name'].tolist())

    # --- 4. çµæœè¡¨ç¤ºã¨é¸æŠ ---
    st.markdown("### ğŸ‘‡ ãŠè©±ã—ãŸã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„")
    
    found_something = False
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ã‚‹ã‚‚ã®ã ã‘ãƒœã‚¿ãƒ³åŒ–
    col1, col2 = st.columns(2) # 2åˆ—ã§è¡¨ç¤ºã—ã¦ã¿ã‚‹
    
    # ãƒ«ãƒ¼ãƒ—ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    idx = 0
    for label in detected_labels:
        if label in showa_db:
            found_something = True
            jp_name = showa_db[label]['ja']
            
            # åˆ—ã‚’äº¤äº’ã«å¤‰ãˆã‚‹å‡¦ç†
            with (col1 if idx % 2 == 0 else col2):
                if st.button(jp_name, key=label):
                    st.session_state['selected_story'] = showa_db[label]['story']
                    st.session_state['selected_name'] = jp_name
            idx += 1

    # ä½•ã‚‚ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆ
    if not found_something:
        if len(detected_labels) > 0:
            st.info(f"ä½•ã‹å†™ã£ã¦ã„ã¾ã™ãŒï¼ˆ{', '.join(list(detected_labels))}ï¼‰ã€æ˜­å’Œã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚‚ã®ã‚’æ’®ã£ã¦ã¿ã¦ãã ã•ã„ï¼")
        else:
            st.warning("ã†ã¾ãèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†å°‘ã—è¿‘ã¥ã„ã¦æ’®ã£ã¦ã¿ã¦ãã ã•ã„ã€‚")

# --- 5. ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¡¨ç¤º ---
if 'selected_story' in st.session_state:
    st.markdown("---")
    st.subheader(f"ã€{st.session_state['selected_name']}ã€‘ã®æ€ã„å‡º")
    
    # èª­ã¿ã‚„ã™ã„ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º
    st.markdown(f"""
    <div style='background-color:#FFF8E1; color:#5D4037; padding:20px; border-radius:10px; border: 2px solid #FFECB3;'>
        <p style='font-size: 22px; line-height: 1.6; font-family: "HiraMinProN-W6", "Mincho", serif;'>
            {st.session_state['selected_story']}
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # ãƒªã‚»ãƒƒãƒˆç”¨
    if st.button("ã‚‚ã†ä¸€åº¦æ’®å½±ã™ã‚‹"):
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()
